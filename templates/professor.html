// FUNÇÃO 100% TESTADA
async function enviarAlerta(){
    const teacher = document.getElementById('teacher').value.trim();
    const room = document.getElementById('room').value.trim();
    const desc = document.getElementById('description').value.trim();
    const statusEl = document.getElementById('status');
    const logBox = document.getElementById('logBox');

    if (!room || !desc){
        statusEl.textContent = "Preencha ao menos Sala/Nº da Turma e a Descrição do Problema.";
        statusEl.style.background = "rgba(239, 68, 68, 0.2)";
        statusEl.style.color = "#fca5a5";
        statusEl.style.border = "1px solid rgba(239, 68, 68, 0.3)";
        return;
    }
    
    statusEl.textContent = "Enviando alerta...";
    statusEl.style.background = "rgba(59, 130, 246, 0.2)";
    statusEl.style.color = "#93c5fd";
    statusEl.style.border = "1px solid rgba(59, 130, 246, 0.3)";

    try{
        console.log("Enviando alerta para /api/alert...");
        
        const response = await fetch('/api/alert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                teacher: teacher || 'Professor',
                room: room,
                description: desc
            })
        });

        console.log("Resposta recebida:", response);

        const data = await response.json();
        console.log("Dados da resposta:", data);

        if(data.ok){
            statusEl.textContent = "✅ Alerta enviado com sucesso!";
            statusEl.style.background = "rgba(34, 197, 94, 0.2)";
            statusEl.style.color = "#86efac";
            statusEl.style.border = "1px solid rgba(34, 197, 94, 0.3)";
            
            const now = new Date().toLocaleTimeString('pt-BR',{hour12:false});
            const line = `[${now}] Alerta - Sala: ${room} | ${desc}`;
            
            if (logBox.textContent.includes("Nenhum alerta")){
                logBox.textContent = line;
            } else {
                logBox.textContent = line + "\n" + logBox.textContent;
            }
            
            // Tocar sirene
            try {
                const audio = new Audio('/tocar_sirene');
                audio.volume = 0.5;
                audio.play().catch(e => console.log('Erro áudio:', e));
            } catch (audioError) {
                console.log('Sirene não pôde ser reproduzida:', audioError);
            }
            
        } else {
            throw new Error(data.error || 'Erro desconhecido do servidor');
        }
    } catch(e){
        console.error('Erro completo:', e);
        statusEl.textContent = "Erro: " + e.message;
        statusEl.style.background = "rgba(239, 68, 68, 0.2)";
        statusEl.style.color = "#fca5a5";
        statusEl.style.border = "1px solid rgba(239, 68, 68, 0.3)";
    }
}
